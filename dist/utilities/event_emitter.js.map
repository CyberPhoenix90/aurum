{"version":3,"file":"event_emitter.js","sourceRoot":"","sources":["../../src/utilities/event_emitter.ts"],"names":[],"mappings":"AAkBA;;GAEG;AACH,MAAM,OAAO,YAAY;IAUxB;QACC,IAAI,CAAC,gBAAgB,GAAG,EAAE,CAAC;QAC3B,IAAI,CAAC,WAAW,GAAG,EAAE,CAAC;IACvB,CAAC;IATD,IAAW,aAAa;QACvB,OAAO,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC;IACrC,CAAC;IASM,SAAS,CAAC,QAA0B,EAAE,iBAAqC;QACjF,MAAM,EAAE,MAAM,EAAE,GAAG,IAAI,CAAC,kBAAkB,CAAC,QAAQ,EAAE,IAAI,CAAC,gBAAgB,EAAE,iBAAiB,CAAC,CAAC;QAE/F,OAAO,MAAM,CAAC;IACf,CAAC;IAEM,gBAAgB;QACtB,OAAO,IAAI,CAAC,aAAa,GAAG,CAAC,CAAC;IAC/B,CAAC;IAEM,SAAS;QACf,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;YACnB,IAAI,CAAC,gBAAgB,CAAC,MAAM,GAAG,CAAC,CAAC;SACjC;aAAM;YACN,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC,IAAI,CAAC,gBAAgB,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;SAChE;IACF,CAAC;IAEO,SAAS;QAChB,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,EAAE;YAChC,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC;YACvC,IAAI,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC;SAC5B;IACF,CAAC;IAEM,IAAI,CAAC,IAAQ;QACnB,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;QAErB,MAAM,MAAM,GAAG,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC;QAC5C,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,EAAE,EAAE;YAChC,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;SACxC;QAED,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC;QACtB,IAAI,CAAC,SAAS,EAAE,CAAC;IAClB,CAAC;IAEO,kBAAkB,CACzB,QAA0B,EAC1B,OAA+B,EAC/B,iBAAqC;QAErC,MAAM,IAAI,GAAS,IAAI,CAAC;QAExB,MAAM,YAAY,GAAyB;YAC1C,QAAQ;SACR,CAAC;QAEF,MAAM,MAAM,GAA4B;YACvC,MAAM;gBACL,IAAI,CAAC,MAAM,CAAC,YAAY,EAAE,OAAO,CAAC,CAAC;YACpC,CAAC;SACD,CAAC;QAEF,IAAI,iBAAiB,KAAK,SAAS,EAAE;YACpC,iBAAiB,CAAC,aAAa,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,YAAY,EAAE,OAAO,CAAC,CAAC,CAAC;SAC1E;QACD,OAAO,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;QAE3B,OAAO,EAAE,YAAY,EAAE,MAAM,EAAE,CAAC;IACjC,CAAC;IAEO,MAAM,CAAC,YAAkC,EAAE,OAA+B;QACjF,IAAI,KAAK,GAAW,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC;QAClD,IAAI,KAAK,IAAI,CAAC,EAAE;YACf,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;gBACnB,OAAO,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC;aACzB;iBAAM;gBACN,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,YAAY,EAAE,OAAO,CAAC,CAAC,CAAC;aAChE;SACD;IACF,CAAC;CACD","sourcesContent":["import { CancellationToken } from '../utilities/cancellation_token';\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface EventSubscriptionFacade {\r\n\tcancel(): void;\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport type EventCallback<T> = (data: T) => void;\r\n\r\ninterface EventSubscription<T> {\r\n\tcallback: EventCallback<T>;\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport class EventEmitter<T> {\r\n\tprivate isFiring: boolean;\r\n\tprivate onAfterFire: Array<() => void>;\r\n\r\n\tpublic get subscriptions(): number {\r\n\t\treturn this.subscribeChannel.length;\r\n\t}\r\n\r\n\tprivate subscribeChannel: EventSubscription<T>[];\r\n\r\n\tconstructor() {\r\n\t\tthis.subscribeChannel = [];\r\n\t\tthis.onAfterFire = [];\r\n\t}\r\n\r\n\tpublic subscribe(callback: EventCallback<T>, cancellationToken?: CancellationToken): EventSubscriptionFacade {\r\n\t\tconst { facade } = this.createSubscription(callback, this.subscribeChannel, cancellationToken);\r\n\r\n\t\treturn facade;\r\n\t}\r\n\r\n\tpublic hasSubscriptions(): boolean {\r\n\t\treturn this.subscriptions > 0;\r\n\t}\r\n\r\n\tpublic cancelAll(): void {\r\n\t\tif (!this.isFiring) {\r\n\t\t\tthis.subscribeChannel.length = 0;\r\n\t\t} else {\r\n\t\t\tthis.onAfterFire.push(() => (this.subscribeChannel.length = 0));\r\n\t\t}\r\n\t}\r\n\r\n\tprivate afterFire() {\r\n\t\tif (this.onAfterFire.length > 0) {\r\n\t\t\tthis.onAfterFire.forEach((cb) => cb());\r\n\t\t\tthis.onAfterFire.length = 0;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic fire(data?: T): void {\r\n\t\tthis.isFiring = true;\r\n\r\n\t\tconst length = this.subscribeChannel.length;\r\n\t\tfor (let i = 0; i < length; i++) {\r\n\t\t\tthis.subscribeChannel[i].callback(data);\r\n\t\t}\r\n\r\n\t\tthis.isFiring = false;\r\n\t\tthis.afterFire();\r\n\t}\r\n\r\n\tprivate createSubscription(\r\n\t\tcallback: EventCallback<T>,\r\n\t\tchannel: EventSubscription<T>[],\r\n\t\tcancellationToken?: CancellationToken\r\n\t): { subscription: EventSubscription<T>; facade: EventSubscriptionFacade } {\r\n\t\tconst that: this = this;\r\n\r\n\t\tconst subscription: EventSubscription<T> = {\r\n\t\t\tcallback\r\n\t\t};\r\n\r\n\t\tconst facade: EventSubscriptionFacade = {\r\n\t\t\tcancel() {\r\n\t\t\t\tthat.cancel(subscription, channel);\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tif (cancellationToken !== undefined) {\r\n\t\t\tcancellationToken.addCancelable(() => that.cancel(subscription, channel));\r\n\t\t}\r\n\t\tchannel.push(subscription);\r\n\r\n\t\treturn { subscription, facade };\r\n\t}\r\n\r\n\tprivate cancel(subscription: EventSubscription<T>, channel: EventSubscription<T>[]): void {\r\n\t\tlet index: number = channel.indexOf(subscription);\r\n\t\tif (index >= 0) {\r\n\t\t\tif (!this.isFiring) {\r\n\t\t\t\tchannel.splice(index, 1);\r\n\t\t\t} else {\r\n\t\t\t\tthis.onAfterFire.push(() => this.cancel(subscription, channel));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n"]}