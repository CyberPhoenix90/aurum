{"version":3,"file":"duplex_data_source.js","sourceRoot":"","sources":["../../src/stream/duplex_data_source.ts"],"names":[],"mappings":"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","sourcesContent":["import { CancellationToken } from '../utilities/cancellation_token';\r\nimport { Callback } from '../utilities/common';\r\nimport { EventEmitter } from '../utilities/event_emitter';\r\nimport { DataSource } from './data_source';\r\n\r\nexport enum DataFlow {\r\n\tUPSTREAM,\r\n\tDOWNSTREAM\r\n}\r\n\r\n/**\r\n * Same as DataSource except data can flow in both directions\r\n */\r\nexport class DuplexDataSource<T> {\r\n\t/**\r\n\t * The current value of this data source, can be changed through update\r\n\t */\r\n\tpublic value: T;\r\n\r\n\tprivate updating: boolean;\r\n\tprivate updateDownstreamEvent: EventEmitter<T>;\r\n\tprivate updateUpstreamEvent: EventEmitter<T>;\r\n\r\n\tconstructor(initialValue?: T) {\r\n\t\tthis.value = initialValue;\r\n\t\tthis.updateDownstreamEvent = new EventEmitter();\r\n\t\tthis.updateUpstreamEvent = new EventEmitter();\r\n\t}\r\n\r\n\t/**\r\n\t * Makes it possible to have 2 completely separate data flow pipelines for each direction\r\n\t * @param downStream stream to pipe downstream data to\r\n\t * @param upstream  stream to pipe upstream data to\r\n\t */\r\n\tpublic static fromTwoDataSource<T>(downStream: DataSource<T>, upstream: DataSource<T>, initialValue?: T) {\r\n\t\tconst result = new DuplexDataSource<T>(initialValue);\r\n\t\t//@ts-ignore\r\n\t\tresult.updateDownstreamEvent = downStream.updateEvent;\r\n\t\t//@ts-ignore\r\n\t\tresult.updateUpstreamEvent = upstream.updateEvent;\r\n\t}\r\n\r\n\t/**\r\n\t * Allows creating a duplex stream that blocks data in one direction. Useful for plugging into code that uses two way flow but only one way is desired\r\n\t * @param direction direction of the dataflow that is allowed\r\n\t */\r\n\tpublic static createOneWay<T>(direction: DataFlow = DataFlow.DOWNSTREAM, initialValue?: T): DuplexDataSource<T> {\r\n\t\treturn new DuplexDataSource(initialValue).oneWayFlow(direction);\r\n\t}\r\n\t/**\r\n\t * Updates the value in the data source and calls the listen callback for all listeners\r\n\t * @param newValue new value for the data source\r\n\t */\r\n\tpublic updateDownstream(newValue: T): void {\r\n\t\tif (this.updating) {\r\n\t\t\tthrow new Error(\r\n\t\t\t\t'Problem in datas source: Unstable value propagation, when updating a value the stream was updated back as a direct response. This can lead to infinite loops and is therefore not allowed'\r\n\t\t\t);\r\n\t\t}\r\n\t\tthis.updating = true;\r\n\t\tthis.value = newValue;\r\n\t\tthis.updateDownstreamEvent.fire(newValue);\r\n\t\tthis.updating = false;\r\n\t}\r\n\r\n\t/**\r\n\t * Updates the value in the data source and calls the listen callback for all listeners\r\n\t * @param newValue new value for the data source\r\n\t */\r\n\tpublic updateUpstream(newValue: T): void {\r\n\t\tif (this.updating) {\r\n\t\t\tthrow new Error(\r\n\t\t\t\t'Problem in datas source: Unstable value propagation, when updating a value the stream was updated back as a direct response. This can lead to infinite loops and is therefore not allowed'\r\n\t\t\t);\r\n\t\t}\r\n\t\tthis.updating = true;\r\n\t\tthis.value = newValue;\r\n\t\tthis.updateUpstreamEvent.fire(newValue);\r\n\t\tthis.updating = false;\r\n\t}\r\n\r\n\t/**\r\n\t * Same as listen but will immediately call the callback with the current value first\r\n\t * @param callback Callback to call when value is updated\r\n\t * @param cancellationToken Optional token to control the cancellation of the subscription\r\n\t * @returns Cancellation callback, can be used to cancel subscription without a cancellation token\r\n\t */\r\n\tpublic listenAndRepeat(callback: Callback<T>, cancellationToken?: CancellationToken): Callback<void> {\r\n\t\tcallback(this.value);\r\n\t\treturn this.listen(callback, cancellationToken);\r\n\t}\r\n\r\n\t/**\r\n\t * Subscribes to the updates of the data stream\r\n\t * @param callback Callback to call when value is updated\r\n\t * @param cancellationToken Optional token to control the cancellation of the subscription\r\n\t * @returns Cancellation callback, can be used to cancel subscription without a cancellation token\r\n\t */\r\n\tpublic listen(callback: Callback<T>, cancellationToken?: CancellationToken): Callback<void> {\r\n\t\tthis.updateDownstreamEvent.subscribe(callback, cancellationToken).cancel;\r\n\t\treturn this.updateUpstreamEvent.subscribe(callback, cancellationToken).cancel;\r\n\t}\r\n\r\n\t/**\r\n\t * Subscribes exclusively to updates of the data stream that occur due to an update flowing upstream\r\n\t * @param callback Callback to call when value is updated\r\n\t * @param cancellationToken Optional token to control the cancellation of the subscription\r\n\t * @returns Cancellation callback, can be used to cancel subscription without a cancellation token\r\n\t */\r\n\tpublic listenUpstream(callback: Callback<T>, cancellationToken?: CancellationToken): Callback<void> {\r\n\t\treturn this.updateUpstreamEvent.subscribe(callback, cancellationToken).cancel;\r\n\t}\r\n\r\n\t/**\r\n\t * Subscribes exclusively to updates of the data stream that occur due to an update flowing downstream\r\n\t * @param callback Callback to call when value is updated\r\n\t * @param cancellationToken Optional token to control the cancellation of the subscription\r\n\t * @returns Cancellation callback, can be used to cancel subscription without a cancellation token\r\n\t */\r\n\tpublic listenDownstream(callback: Callback<T>, cancellationToken?: CancellationToken): Callback<void> {\r\n\t\treturn this.updateDownstreamEvent.subscribe(callback, cancellationToken).cancel;\r\n\t}\r\n\r\n\t/**\r\n\t * Creates a new datasource that listenes to updates of this datasource but only propagates the updates from this source if they pass a predicate check\r\n\t * @param callback predicate check to decide if the update from the parent data source is passed down or not\r\n\t * @param cancellationToken  Cancellation token to cancel the subscriptions added to the datasources by this operation\r\n\t */\r\n\tpublic filter(downStreamFilter: (value: T) => boolean, upstreamFilter?: (value: T) => boolean, cancellationToken?: CancellationToken): DuplexDataSource<T> {\r\n\t\tif (!upstreamFilter) {\r\n\t\t\tupstreamFilter = downStreamFilter;\r\n\t\t}\r\n\r\n\t\tconst filteredSource = new DuplexDataSource<T>();\r\n\t\tthis.listenDownstream((newVal) => {\r\n\t\t\tif (downStreamFilter(newVal)) {\r\n\t\t\t\tfilteredSource.updateDownstream(newVal);\r\n\t\t\t}\r\n\t\t}, cancellationToken);\r\n\r\n\t\tfilteredSource.listenUpstream((newVal) => {\r\n\t\t\tif ((upstreamFilter ?? downStreamFilter)(newVal)) {\r\n\t\t\t\tthis.updateUpstream(newVal);\r\n\t\t\t}\r\n\t\t}, cancellationToken);\r\n\r\n\t\treturn filteredSource;\r\n\t}\r\n\r\n\t/**\r\n\t * Forwards all updates from this source to another\r\n\t * @param targetDataSource datasource to pipe the updates to\r\n\t * @param cancellationToken  Cancellation token to cancel the subscriptions added to the datasources by this operation\r\n\t */\r\n\tpublic pipe(targetDataSource: DuplexDataSource<T>, cancellationToken?: CancellationToken): void {\r\n\t\tthis.listenDownstream((newVal) => targetDataSource.updateDownstream(newVal), cancellationToken);\r\n\t\ttargetDataSource.listenUpstream((newVal) => this.updateUpstream(newVal), cancellationToken);\r\n\t}\r\n\r\n\t/**\r\n\t * Creates a new datasource that is listening to updates from this datasource and transforms them with a mapper function before fowarding them to itself\r\n\t * @param mapper mapper function that transforms the data when it flows downwards\r\n\t * @param reverseMapper mapper function that transforms the data when it flows upwards\r\n\t * @param cancellationToken  Cancellation token to cancel the subscriptions added to the datasources by this operation\r\n\t */\r\n\tpublic map<D>(mapper: (value: T) => D, reverseMapper: (value: D) => T, cancellationToken?: CancellationToken): DuplexDataSource<D> {\r\n\t\tconst mappedSource = new DuplexDataSource<D>(mapper(this.value));\r\n\r\n\t\tthis.listenDownstream((v) => mappedSource.updateDownstream(mapper(v)), cancellationToken);\r\n\t\tmappedSource.listenUpstream((v) => this.updateUpstream(reverseMapper(v)), cancellationToken);\r\n\r\n\t\treturn mappedSource;\r\n\t}\r\n\r\n\t/**\r\n\t * Creates a new datasource that listens to this one and forwards updates if they are not the same as the last update\r\n\t * @param cancellationToken  Cancellation token to cancel the subscription the new datasource has to this datasource\r\n\t */\r\n\tpublic unique(cancellationToken?: CancellationToken): DuplexDataSource<T> {\r\n\t\tconst uniqueSource = new DuplexDataSource<T>(this.value);\r\n\r\n\t\tthis.listenDownstream((v) => {\r\n\t\t\tif (uniqueSource.value !== v) {\r\n\t\t\t\tuniqueSource.updateDownstream(v);\r\n\t\t\t}\r\n\t\t}, cancellationToken);\r\n\r\n\t\tuniqueSource.listenUpstream((v) => {\r\n\t\t\tif (this.value !== v) {\r\n\t\t\t\tthis.updateUpstream(v);\r\n\t\t\t}\r\n\t\t}, cancellationToken);\r\n\r\n\t\treturn uniqueSource;\r\n\t}\r\n\r\n\t/**\r\n\t * Allows flow of data only in one direction\r\n\t * @param direction direction of the dataflow that is allowed\r\n\t * @param cancellationToken  Cancellation token to cancel the subscriptions the new datasource has to the two parent datasources\r\n\t */\r\n\tpublic oneWayFlow(direction: DataFlow = DataFlow.DOWNSTREAM, cancellationToken?: CancellationToken): DuplexDataSource<T> {\r\n\t\tconst oneWaySource = new DuplexDataSource(this.value);\r\n\r\n\t\tif (direction === DataFlow.DOWNSTREAM) {\r\n\t\t\tthis.listenDownstream((v) => oneWaySource.updateDownstream(v), cancellationToken);\r\n\t\t\toneWaySource.updateUpstream = () => void 0;\r\n\t\t} else {\r\n\t\t\toneWaySource.listenUpstream((v) => this.updateUpstream(v));\r\n\t\t\toneWaySource.updateDownstream = () => void 0;\r\n\t\t}\r\n\r\n\t\treturn oneWaySource;\r\n\t}\r\n\r\n\t/**\r\n\t * Remove all listeners\r\n\t */\r\n\tpublic cancelAll(): void {\r\n\t\tthis.updateDownstreamEvent.cancelAll();\r\n\t\tthis.updateUpstreamEvent.cancelAll();\r\n\t}\r\n}\r\n"]}