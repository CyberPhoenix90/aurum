{"version":3,"file":"object_data_source.js","sourceRoot":"","sources":["../../src/stream/object_data_source.ts"],"names":[],"mappings":"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","sourcesContent":["import { DataSource } from './data_source';\nimport { Callback } from '../utilities/common';\nimport { CancellationToken } from '../utilities/cancellation_token';\nimport { EventEmitter } from '../utilities/event_emitter';\n\nexport interface ObjectChange<T, K extends keyof T> {\n\tkey: K;\n\toldValue: T[K];\n\tnewValue: T[K];\n\tdeleted?: boolean;\n}\n\nexport class ObjectDataSource<T> {\n\tprotected data: T;\n\tprivate updateEvent: EventEmitter<ObjectChange<T, keyof T>>;\n\tprivate updateEventOnKey: Map<keyof T, EventEmitter<ObjectChange<T, keyof T>>>;\n\n\tconstructor(initialData: T) {\n\t\tif (initialData) {\n\t\t\tthis.data = initialData;\n\t\t}\n\n\t\tthis.updateEvent = new EventEmitter();\n\t\tthis.updateEventOnKey = new Map();\n\t}\n\n\t/**\n\t * Creates a datasource for a single key of the object\n\t * @param key\n\t * @param cancellationToken\n\t */\n\tpublic pick(key: keyof T, cancellationToken?: CancellationToken): DataSource<T[typeof key]> {\n\t\tconst subDataSource: DataSource<T[typeof key]> = new DataSource(this.data?.[key]);\n\n\t\tthis.listenOnKey(\n\t\t\tkey,\n\t\t\t(v) => {\n\t\t\t\tsubDataSource.update(v.newValue);\n\t\t\t},\n\t\t\tcancellationToken\n\t\t);\n\n\t\treturn subDataSource;\n\t}\n\n\t/**\n\t * Listen to changes of the object\n\t */\n\tpublic listen(callback: Callback<ObjectChange<T, keyof T>>, cancellationToken?: CancellationToken): Callback<void> {\n\t\treturn this.updateEvent.subscribe(callback, cancellationToken).cancel;\n\t}\n\n\t/**\n\t * Same as listenOnKey but will immediately call the callback with the current value first\n\t */\n\tpublic listenOnKeyAndRepeat<K extends keyof T>(key: K, callback: Callback<ObjectChange<T, K>>, cancellationToken?: CancellationToken): Callback<void> {\n\t\tcallback({\n\t\t\tkey,\n\t\t\tnewValue: this.data[key],\n\t\t\toldValue: undefined\n\t\t});\n\n\t\treturn this.listenOnKey(key, callback, cancellationToken);\n\t}\n\n\t/**\n\t * Listen to changes of a single key of the object\n\t */\n\tpublic listenOnKey<K extends keyof T>(key: K, callback: Callback<ObjectChange<T, K>>, cancellationToken?: CancellationToken): Callback<void> {\n\t\tif (!this.updateEventOnKey.has(key)) {\n\t\t\tthis.updateEventOnKey.set(key, new EventEmitter());\n\t\t}\n\t\tconst event = this.updateEventOnKey.get(key);\n\t\treturn event.subscribe(callback, cancellationToken).cancel;\n\t}\n\n\t/**\n\t * Returns all the keys of the object in the source\n\t */\n\tpublic keys(): string[] {\n\t\treturn Object.keys(this.data);\n\t}\n\n\t/**\n\t * Returns all the values of the object in the source\n\t */\n\tpublic values(): any {\n\t\treturn Object.values(this.data);\n\t}\n\n\t/**\n\t * get the current value of a key of the object\n\t * @param key\n\t */\n\tpublic get<K extends keyof T>(key: K): T[K] {\n\t\treturn this.data[key];\n\t}\n\n\t/**\n\t * delete a key from the object\n\t * @param key\n\t * @param value\n\t */\n\tpublic delete<K extends keyof T>(key: K, value: T[K]): void {\n\t\tconst old = this.data[key];\n\t\tdelete this.data[key];\n\t\tthis.updateEvent.fire({ oldValue: old, key, newValue: undefined, deleted: true });\n\t}\n\n\t/**\n\t * set the value for a key of the object\n\t * @param key\n\t * @param value\n\t */\n\tpublic set<K extends keyof T>(key: K, value: T[K]): void {\n\t\tif (this.data[key] === value) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst old = this.data[key];\n\t\tthis.data[key] = value;\n\t\tthis.updateEvent.fire({ oldValue: old, key, newValue: this.data[key] });\n\t\tif (this.updateEventOnKey.has(key)) {\n\t\t\tthis.updateEventOnKey.get(key).fire({ oldValue: old, key, newValue: this.data[key] });\n\t\t}\n\t}\n\n\t/**\n\t * Merge the key value pairs of an object into this object non recursively\n\t * @param newData\n\t */\n\tpublic assign(newData: Partial<T>): void {\n\t\tfor (const key of Object.keys(newData)) {\n\t\t\tthis.set(key as keyof T, newData[key]);\n\t\t}\n\t}\n\n\t/**\n\t * Returns a shallow copy of the object\n\t */\n\tpublic toObject(): T {\n\t\treturn { ...this.data };\n\t}\n\n\t/**\n\t * Returns a simplified version of this datasource\n\t */\n\tpublic toDataSource(): DataSource<T> {\n\t\tconst stream = new DataSource(this.data);\n\t\tthis.listen((s) => {\n\t\t\tstream.update(this.data);\n\t\t});\n\t\treturn stream;\n\t}\n}\n"]}